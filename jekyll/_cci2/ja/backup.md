---
layout: classic-docs
title: "CircleCIデータのバックアップ"
category:
  - 管理
order: 50
description: "CircleCIインストールの定期的なバックアップ方法"
---
このドキュメントでは、CircleCIアプリケーションをバックアップし、Servicesマシンに存在するCircleCIデータが事故や予期しない理由で消失した場合に回復する方法について説明します。

* TOC {:toc}

**注: **CircleCIをHA構成で実行している場合、外部データストアの標準のバックアップ機構を使用する必要があります。 詳細については、『[高可用性]({{site.baseurl}}/2.0/high-availability/)』ドキュメントを参照してください。

## データベースのバックアップ

CircleCIをHA用に構成**していない**場合、CircleCIデータをバックアップするためのベストプラクティスとして、Servicesマシンのルートボリュームとして機能する、仮想ディスクのVMスナップショットを使用することをお勧めします。 基盤となる仮想ディスクが、AWS EBSと同様にこの動作をサポートしていれば、停止時間なしにバックアップを実行できます。 再ブートなしにスナップショットを作成すると、ファイルシステムと分散によっては、一部のデータが破損する多少のリスクが存在しますが、これは実際には稀です。 停止時間なしのバックアップと、データ破損の問題に対する堅牢性の両方が不可欠な場合、[HA構成]({{site.baseurl}}/2.0/high-availability/)が適切な場合もあります。

## オブジェクトストレージのバックアップ

ビルドアーティファクト、出力、キャッシュは通常、AWS S3などのオブジェクトストレージ・サービスに保存されます。 これらのサービスは冗長性が高いため、別のバックアップを必要とする可能性は低いと考えられます。 ただし、インスタンスがディスク上に直接、またはNFSボリューム上で、Servicesマシンに大きなオブジェクトをローカルに保存するようセットアップされている場合は例外となります。 この場合、これらのファイルを別にバックアップし、復元時に同じ場所へマウントされることを保証する必要があります。

## AWS EBSのスナップショットの作成

AWS EBSスナップショットには、バックアップ処理を簡単にするため、いくつかの機能が搭載されています。

1. 手動でバックアップを作成するには、EC2コンソールでインスタンスを選択し、[アクション] > [イメージ] > [イメージの作成] を選択します。

2. 停止時間を避けるには、[リブートなし] オプションを選択します。復元用のAMIが作成され、新しいEC2インスタンスとしていつでも実行できます。

また、AWS APIを使用して、このプロセスを自動化することもできます。 それ以後のAMIやスナップショットは、前回のスナップショット以後の差分(変更されたブロック)分の大きさしかないため、頻繁にスナップショットを作成した場合に不必要なストレージコストは発生しません。詳細については、「[Amazon EBS スナップショットの利用料金はどのように計算されていますか?](https://aws.amazon.com/premiumsupport/knowledge-center/ebs-snapshot-billing/)」ドキュメントを参照してください。

## バックアップからの復元

テスト用バックアップの復元、または運用環境で復元を実行するとき、公開または非公開IPアドレスが変更されている場合は、新たに開始されたインスタンスにいくつかの変更が必要になることがあります。

1. 以前の手順で新たに生成されたAMIを使用して、新しいEC2インスタンスを開始します。
2. 管理コンソール(のポート8800)で実行されているアプリがあれば、停止します。
3. 管理コンソールのポート8800で構成されているホスト名が、正しいアドレスを反映していることを確認します。 ホスト名が変更されている場合、対応するGitHub OAuthアプリケーションの設定も変更するか、新しいOAuthアプリケーションを復元テスト用に作成し、そのアプリケーションにログインする必要があります。
4. Debian/Ubuntuの`/etc/default/replicated`および`/etc/default/replicated-operator`、またはRHEL/CentOSの`/etc/sysconfig/*`にある、バックアップされたインスタンスの公開および非公開IPアドレスへの参照をすべて、新しいIPアドレスに変更します。
5. Servicesボックスのルートディレクトリから、`sudo rm -rf /opt/nomad`を実行します。
6. 管理コンソールのポート8800で、アプリケーションを再起動します。

## ビルドレポートのクリーンアップ

ファイルシステム・レベルのデータ整合性の問題は稀であり、防止可能ですが、ビルドがシステムで実行中の特定の時間に作成されたバックアップでは、一部のデータ異常の可能性が高くなります。 たとえば、バックアップの時点でビルトが半分しか完了していなかった場合、コマンド出力の後半が存在せず、アプリケーションは恒久的に実行中の状態として示される可能性があります。

復元後に、データベース内の異常なビルドレコードをクリーンアップするには、Servicesマシンで次のコマンドを実行します。ここで、例のビルドURLは、CircleCIアプリケーションの実際のURLに置き換えます。

    $ circleci dev-console
    # コンソールのロードを待つ
    user=> (admin/delete-build "https://my-circleci-hostname.com/gh/my-org/my-project/1234")